---
marp: true
theme: hegel
---

# 60分で学ぶE2Eテスト（実践編）

---

# 利用する技術の選定

いくつか軸があります

---

# 利用する技術の選定

## クロスブラウザ・クロスデバイスはどのぐらい必要？

やるやら | フレームワーク
---|---
いらない | Cypress
いる | PlayWright
超いる | Selenium

---
### 参考: クロスブラウザ・クロスデバイスについて

- 「いろんなブラウザでテスト出来たほうがいいじゃん」と思ってしまうのが人の常
- 実際は自動テストを使おうが使わまいがクロスブラウザ対応はしんどい
  - IE対応が辛いのはテストが辛いからじゃない、IEが辛いからだ
  - **おまえは本当にIEについて良く理解しながらIEに対応しているのか？**
- クロスブラウザテストできる ≠ クロスブラウザテストが **期待通り** 動く
  - 自動化レイヤーのバグを踏むことも多い
- nice to have でクロスブラウザに手を出さないこと
  - お兄さんとの約束だよ

---

# 利用する技術の選定

## テストコードを読むのは開発者だけか？

- 開発者だけ → 普通のテストツールで良い
- チームみんなで読む → BDD系のツールを使う

---
### 参考: BDD (Behavior Driven Development)

- 自然言語でプロダクトの **振る舞い** を記述するためのツール
  - 独自の **自然言語っぽい** 記述を使うもの
  - Markdown を使うもの
- チーム全体でプロダクトの振る舞いを考えて、それを自動化するためのもの
- ノーコードのツールとは違う
  - プログラミング不要でテスト自動化できるツールは志向していない
- 今日はこの話はしません
  - が、ここはここで *かなりアツい* 領域……
  - この話がしたいひとは後で声かけてください

---

今回は

**クロスブラウザは割り切る** し、

**テストコードは開発者がメンテする** ということで、

*Cypress* にします

---

# Cypressについて

デベロッパーフレンドリーなE2Eテストツール

- Chrome/Firefoxに対応
- テストコードの作成やデバッグを楽にする機能がいろいろある

---

# Cypressのインストール

NodeJSのインストールが必要です

Macの場合は以下

```bash
$ brew install node
```

---

# インストール

```bash
$ mkdir jasst22tokyo
$ cd jasst22tokyo
$ npm install cypress @testing-library/cypress
```

---

# 起動

```bash
$ npx cypress open
```

初回起動時に設定ファイルとサンプルのテストコードが生成されます

---

![cypress_open](./images/cypress_open.png)

---

![cypress_run](./images/cypress_run.png)

テストを実行すると実行結果が細かく表示されます

---

# 早速書いていきます

テストシナリオ

- **会員登録して予約してログアウト**
- プレミアム会員でログインして予約してログアウト
- 一般会員でログインして予約してログアウト
  - 一般会員の画面でプレミアム会員向けプランが出ていないことをテスト

---

# まずはステップを書き起こす

- テスト対象のサイトにアクセス
- 会員登録
- 宿泊プランを選択
- 宿泊予約
- 予約内容の確認
- ログアウト

---

# まずはステップを書き起こす

<div class="columns">
<div>

## テスト対象のサイトにアクセス

```js
- `https://hotel.testplanisphere.dev/ja/` にアクセス
```

</div>
<div>

![hoteltop](images/hoteltop.png)

</div>

---

# まずはステップを書き起こす

<div class="columns">

<div>

## 会員登録

```js
- `会員登録` をクリック
- `メールアドレス` に `jasst21@example.com` と入力
- `パスワード` に `P@ssw0rd` と入力
- `パスワード（確認）` に `P@ssw0rd` と入力
- `氏名` に `ジャスト 太郎` と入力
- `住所` に `東京都千代田区千代田1-1-1` と入力
- `電話番号` に `090-0000-0000` と入力
- `性別` に `その他` と入力
- `生年月日` に `1987/03/16` と入力
- `お知らせを受け取る` に チェックを入れる
```

<!--
- `メニューバー` の `会員登録` をクリック
- `会員登録フォーム` の `メールアドレス` に `jasst21@example.com` と入力
- `会員登録フォーム` の `パスワード` に `P@ssw0rd` と入力
- `会員登録フォーム` の `パスワード（確認）` に `P@ssw0rd` と入力
- `会員登録フォーム` の `氏名` に `ジャスト 太郎` と入力
- `会員登録フォーム` の `住所` に `東京都千代田区千代田1-1-1` と入力
- `会員登録フォーム` の `電話番号` に `090-0000-0000` と入力
- `会員登録フォーム` の `性別` に `その他` と入力
- `会員登録フォーム` の `生年月日` に `1987/03/16` と入力
- `会員登録フォーム` の `お知らせを受け取る` に チェックを入れる
 -->

</div>
<div>

![register](images/register.png)

</div>
</div>

---

# まずはステップを書き起こす

<div class="columns">

<div>

## 宿泊プランの選択

```js
- `宿泊予約` をクリック
- `このプランで予約` をクリック
```

<!--
- `メニューバー` の `宿泊予約` をクリック
- `素泊まり` を含む `宿泊プラン` の
  `このプランで予約` をクリック
 -->

</div>
<div>

![select-plan](images/select-plan.png)

</div>

---

# まずはステップを書き起こす

<div class="columns">

<div>

## 宿泊予約

```js
- `宿泊日` に `2022/03/16` を入力
- `宿泊数` に `3` と入力
- `人数` に `2` と入力
- `朝食バイキング` にチェックを入れる
- `氏名` が `ジャスト 太郎` であることを確認
- `確認のご連絡` に `メールでのご連絡` を選択
- `ご要望・ご連絡事項等ありましたらご記入ください` に
  `朝食はお部屋まで\n持ってきてください` と入力
- `予約内容を確認する` をクリック
```

</div>
<div>

![reserve](images/reserve.png)

</div>
</div>

---

# まずはステップを書き起こす

<div class="columns">

<div>

## 予約内容の確認

```js
- `合計 5,500円（税込み）` と表示されていることを確認
- `素泊まり` と表示されていることを確認
- `期間` に `2022年2月9日 〜 2022年2月10日 1泊` と
  表示されていることを確認
- `人数` に `1名様` と表示されていることを確認
- `追加プラン` に `なし` と表示されていることを確認
- `人数` に `1名様` と表示されていることを確認
- `お名前` に `ジャスト 太郎` と表示されていることを確認
- `確認のご連絡` に `希望しない` と表示されていることを確認
- `ご要望・ご連絡事項等` に
  `朝食はお部屋まで\n持ってきてください` と
  表示されていることを確認
- `この内容で予約する` をクリック
- `予約を完了しました` と
  表示されていることを確認
- `閉じる` をクリック
```

</div>
<div>

![reserve-confirmation](images/reserve-confirmation.png)

</div>

---

# まずはステップを書き起こす

## ログアウト

```js
- `ログアウト` をクリック
- `ログアウト` が表示されていないことを確認
- `ログイン` が表示されていることを確認
```

<!--

- `メニューバー` の `ログアウト` をクリック
- `メニューバー` に `ログアウト` が表示されていないことを確認
- `メニューバー` に `ログイン` が表示されていることを確認 -->

---

# テストコードを書いてみよう


`smoke_test.js` を作成

```js
describe('スモークテスト', () => {
  it('会員登録して予約してログアウト', () => {
    // ここにテストコードを書いていきます
  })
})
```

---

# テストコードを書いてみよう

## テスト対象のサイトにアクセス

```js
cy.visit("https://hotel.testplanisphere.dev/ja/index.html");
```

ここは簡単ですね

---

# テストコードを書いてみよう


<div class="columns">

<div>

## 会員登録画面に遷移

```js
- `会員登録` をクリック
```

</div>
<div>

Cypressでは `contain()` を使って
特定の文字を含む要素を指定できる

```js
cy.contain('会員登録').click
```


</div>
</div>

---


# あいまいな指定を減らす

<div class="columns">
<div>

![](images/account-registration.png)

</div>
<div>

```js
- `会員登録` をクリック
```

- 「会員登録」という文字は2箇所
- どちらをクリックする？

</div>
</div>

---

# あいまいな指定を減らす

1. サイトの構造を使う
   1. `メニューバー` の中の `会員登録` をクリック
2. 要素のセマンティクスを使う
   1. `会員登録` リンクをクリック

併用することもできる

---

# サイトの構造を使ってテストを書く

`within` を使うと、「xxの中のyy」という構造を表現できる

```js
within('nav', () => {
  cy.contain('会員登録').click
})
```

---

